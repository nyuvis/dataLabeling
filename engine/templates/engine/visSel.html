<!DOCTYPE html>
{% load static%}
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <title>Bootstrap 101 Template</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">
    
    <!-- d3 -->
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-lasso@0.0.5/build/d3-lasso.min.js"></script>

    <!-- <link href="theme.css" rel="stylesheet"> -->
    <link href="{%static 'theme.css' %}" rel="stylesheet">
    
    <!-- HTML5 shim 和 Respond.js 是为了让 IE8 支持 HTML5 元素和媒体查询（media queries）功能 -->
    <!-- 警告：通过 file:// 协议（就是直接将 html 页面拖拽到浏览器中）访问页面时 Respond.js 不起作用 -->
    <!--[if lt IE 9]>
      <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top">
        <div class="container">
          <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#">Data Labeling</a>
          </div>
          <div class="navbar-collapse collapse">
            <ul class="nav navbar-nav">
                <li><a href="../engine/">Home</a></li>
                <li><a href="../engine/datasetOverview">Dataset Explore</a></li>
                <!-- <li><a href="#contact">Contact</a></li> -->
                <li class="dropdown" class="active">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">VIS<span class="caret"></span></a>
                  <ul class="dropdown-menu">
                    <li class="active"><a href="../engine/visSel">ScatterPlot</a></li>
                    <li><a href="classifierVis">ClassifierVis</a></li>
                    <li ><a href="radarVis">RadarVis</a></li>
                    <li><a href="parallelVis">parallelVis</a></li>
                    <li><a href="dotVis">dotVis</a></li>
                    <!-- <li role="separator" class="divider"></li>
                    <li class="dropdown-header">Nav header</li>
                    <li><a href="#">Separated link</a></li>
                    <li><a href="#">One more separated link</a></li> -->
                  </ul>
                </li>
                <li><a id = "saveToFile">Save</a></li>
              </ul>
          </div><!--/.nav-collapse -->
        </div>
    </nav>

    <div class="container">

        <div class="row">
            <div class="col-md-6" id = "mainView">
                <div class="panel panel-default" id = "scatterPlot_panel">
                    <div class="panel-heading">
                        <h3 class="panel-title">ScatterPlot</h3>
                    </div>
                    <div class="panel-body" id="scatterPlot">
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                      <h3 class="panel-title">Review Content</h3>
                    </div>
                    <div class="panel-body" id='text_being_labeled'>
                      Panel content
                    </div>
                </div>
                <!-- <p id='text_being_labeled'>Text here</p> -->
            </div>
            <div class="col-md-2">
                <div class="panel panel-default" id = "labelView_label">
                    <div class="panel-heading">
                        <h3 class="panel-title">Label</h3>
                    </div>
                    <div class="panel-body" id="text_being_labeled">
                        <div class="row">
                            <div class="col-md-3"></div>
                            <div class="col-md-9">
                            <!-- "Hotels", "Restaurants", "Beauty & Spas", "Real Estate", "Airports", "Pets", "Doctors", "Auto Repair", "Lawyers" -->
                            <label class="radio">
                                <input type="radio" name="inlineRadioOptions" id="inlineRadio1" value="Hotels"> Hotels
                            </label>
                            <label class="radio">
                                <input type="radio" name="inlineRadioOptions" id="inlineRadio2" value="Restaurants"> Restaurants
                            </label>
                            <label class="radio">
                                <input type="radio" name="inlineRadioOptions" id="inlineRadio3" value="Beauty & Spas"> Beauty & Spas
                            </label>
                            <label class="radio">
                                <input type="radio" name="inlineRadioOptions" id="inlineRadio4" value="Real Estate"> Real Estate
                            </label>
                            <label class="radio">
                                <input type="radio" name="inlineRadioOptions" id="inlineRadio5" value="Airports"> Airports
                            </label>
                            <label class="radio">
                                <input type="radio" name="inlineRadioOptions" id="inlineRadio6" value="Pets"> Pets
                            </label>
                            <label class="radio">
                                <input type="radio" name="inlineRadioOptions" id="inlineRadio7" value="Doctors"> Doctors
                            </label>
                            <label class="radio">
                                <input type="radio" name="inlineRadioOptions" id="inlineRadio8" value="Auto Repair"> Auto Repair
                            </label>
                            <label class="radio">
                                <input type="radio" name="inlineRadioOptions" id="inlineRadio8" value="Lawyers"> Lawyers
                            </label>
                            <!-- <button type="button" class="btn btn-sm btn-default" id = "next_doc_button">Next</button> -->
                            <button type="button" class="btn btn-sm btn-default" id = "label_doc_button">label it</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="row" id = "labelView_text">

            </div>
        </div>

    </div>

    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@1.12.4/dist/jquery.min.js"></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.3.7/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript">
        var data_dict= {{data_dict | safe}}
        var indexOfSelectedDoc = 0

        var data_list = []
        for (var key in data_dict){
            data_list.push(data_dict[key])
        }


        var zoomState = null
        var ZoomEnable = true
        var lassoSelectedDocs_id = []
        var Append_mode = false

        let radius_normal = 6
        let radius_selected = 8
        let color_default = "#69b3a2"
        let color_selected = "#EC888C"
        let color_target = "red"
        let color_before_mouseover = null
        let radius_before_mouseover = null

        let bb = document.querySelector('#scatterPlot')
            .getBoundingClientRect()
        let shape = {
            innerwidth: bb.right - bb.left,
            innerheight: 0
        }
        shape.innerheight = shape.innerwidth
        let margin = {
            left: 20,
            top: 10,
            right: 10,
            bottom: 20
        }

        renderScatterPlot()

        function renderScatterPlot(){
            $("#scatterPlot").empty();
            let svg_scatterPlot = d3.select('#scatterPlot')
            .append('svg')
            .attr("viewBox", [0, 0, shape.innerwidth, shape.innerheight])

            let value_range = [[-50, 50],[-50, 50]]
            var x = d3.scaleLinear()
                .domain(value_range[0])
                .range([0, shape.innerwidth]);
            var y = d3.scaleLinear()
                .domain(value_range[1])
                .range([shape.innerheight, 0]);
            // xAxis = svg_scatterPlot.append("g")
            //     .attr("id", "xAxis")
            //     .attr("transform", "translate(0," + String(shape.innerheight - margin.bottom) + ")")
            //     .call(d3.axisBottom(x));
            // yAxis = svg_scatterPlot.append("g")
            //     .attr("id", "yAxis")
            //     .attr("transform", "translate(" + margin.left + ", 0)")
            //     .call(d3.axisLeft(y));
            // xAxis = svg_scatterPlot.call(d3.axisBottom(x));
            // yAxis = svg_scatterPlot.call(d3.axisLeft(y));
            var clip = svg_scatterPlot.append("defs")
                .append("SVG:clipPath")
                .attr("id", "clip")
                .append("SVG:rect")
                .attr("width", shape.innerwidth)
                .attr("height", shape.innerheight)
                .attr("x", 0)
                .attr("y", 0);

            var scatter = svg_scatterPlot.append('g')
                .attr("clip-path", "url(#clip)")

            
            let all_dots = scatter.selectAll(".dot")
                .data(data_list)
                .enter()
                .append("circle")
                .attr("class", "dot")
                .attr("id", function(d) {
                    return "dot_" + d.index;
                })
                .attr("cx", function(d) {
                    return x(d.coord[0]);
                })
                .attr("cy", function(d) {
                    return y(d.coord[1]);
                })
                .attr("r", radius_normal)
                .style("fill", d => assignColor(d.index, d.isLabeled))
                // .style("fill", color_default)
                .style("fill-opacity", 0.5)
                .on("mouseover", handleMouseOver)
                .on("mouseout", handleMouseOut)
                .on("click", function(d) {
                    d3.select('#dot_' + indexOfSelectedDoc).style("fill", color_default)
                    indexOfSelectedDoc = d.index
                    d3.select('#dot_' + indexOfSelectedDoc).style("fill", color_target)
                    d3.select('#text_being_labeled')
                        .text(data_dict[d.index]['doc'])
                });

            let zoom = d3.zoom()
                .scaleExtent([.5, 20]) // This control how much you can unzoom (x0.5) and zoom (x20)
                .extent([
                    [0, 0],
                    [shape.innerwidth, shape.innerheight]
                ])
                .on("zoom", updateChart);

            if (ZoomEnable) {
                var zoom_area = svg_scatterPlot.append("rect")
                    .attr("width", shape.innerwidth)
                    .attr("height", shape.innerheight)
                    .style("fill", "none")
                    .style("pointer-events", "all")
                    // .call(zoom)
                if (zoomState === null) {
                    zoom_area.call(zoom)
                } else {
                    zoom_area.call(zoom.transform, d3.zoomIdentity.scale(zoomState.k).translate(zoomState.x / zoomState.k, zoomState.y / zoomState.k))
                    zoom_area.call(zoom)
                }
            } else {
                lasso()
                // xAxis.call(d3.axisBottom(x_temp))
                // yAxis.call(d3.axisLeft(y_temp))
                scatter
                    .selectAll(".dot")
                    .attr('cx', function(d) {
                        return x_temp(d.coord[0])
                    })
                    .attr('cy', function(d) {
                        return y_temp(d.coord[1])
                    });
            }
        

            function handleMouseOver(d, i) {
                let id_temp = '#dot_' + d.index
                color_before_mouseover = d3.select(id_temp).style("fill")
                radius_before_mouseover = d3.select(id_temp).attr("r")
                d3.select('#dot_' + d.index)
                    .attr("r", radius_selected)
                    .style("fill", "orange");
                svg_scatterPlot.append("text")
                    .text(d.index)
                    .attr("id", "t_" + d.index)
                    .attr("x", function() {
                        if (x_temp === null) {
                            return x(d.coord[0]) + 5;
                        } else {
                            return x_temp(d.coord[0]) + 5;
                        }
                    })
                    .attr("y", function() {
                        if (y_temp === null) {
                            return y(d.coord[1]) - 5;
                        } else {
                            return y_temp(d.coord[1]) - 5;
                        }

                    });
            }

            function handleMouseOut(d, i) {
                d3.select('#dot_' + d.index)
                    .attr("r", radius_before_mouseover)
                    .style("fill", color_before_mouseover);
                d3.select("#t_" + d.index).remove(); // Remove text location
                d3.select('#dot_' + indexOfSelectedDoc).style("fill", color_target)
            }

            function updateChart() {
                // recover the new scale
                var newX = d3.event.transform.rescaleX(x);
                var scale_k = d3.event.transform.k
                var newY = d3.event.transform.rescaleY(y);

                x_temp = newX
                y_temp = newY

                // update axes with these new boundaries
                // xAxis.call(d3.axisBottom(newX))
                // yAxis.call(d3.axisLeft(newY))

                // update circle position
                scatter
                    .selectAll(".dot")
                    .attr('cx', function(d) {
                        return newX(d.coord[0])
                    })
                    .attr('cy', function(d) {
                        return newY(d.coord[1])
                    });
                for (let i = 0; i < lassoSelectedDocs_id.length; i++) {
                    let id_t = "#dot_" + lassoSelectedDocs_id[i]
                    scatter
                        .select(id_t)
                        .style("fill", color_selected);
                }
                zoomState = d3.event.transform
            }
            function renderSelectedNodes(scatter, lassoSelectedDocs_id, color_selected) {
                for (let i = 0; i < lassoSelectedDocs_id.length; i++) {
                    let id_t = "#dot_" + lassoSelectedDocs_id[i]
                    scatter
                        .select(id_t)
                        .style("fill", color_selected);
                }
            }
            function lasso() {
                
                // Lasso functions
                let lasso_start = function() {
                    lasso.items()
                        .attr("r", radius_normal) // reset size
                        .classed("not_possible", true)
                        .classed("selected", false);
                    scatter.select("#dot_" + indexOfSelectedDoc).style("fill", color_target)
                };

                let lasso_draw = function() {

                    // Style the possible dots
                    lasso.possibleItems()
                        .classed("not_possible", false)
                        .classed("possible", true);

                    // Style the not possible dot
                    lasso.notPossibleItems()
                        .classed("not_possible", true)
                        .classed("possible", false);

                    if (!Append_mode) {
                        lassoSelectedDocs_id = []
                    }
                    scatter.select("#dot_" + indexOfSelectedDoc).style("fill", color_target)
                };

                let lasso_end = function() {
                    // Reset the color of all dots
                    lasso.items()
                        .classed("not_possible", false)
                        .classed("possible", false);

                    // Style the selected dots
                    lasso.selectedItems()
                        .classed("selected", true)
                        .attr("r", radius_selected)
                        .style("fill", color_selected);

                    scatter.selectAll(".selected")
                        .classed("selected", true)

                    // Reset the style of the not selected dots
                    lasso.notSelectedItems()
                        .attr("r", radius_normal)
                        .style("fill", d => assignColor(Number(d.index), d.isLabeled))

                    scatter.select("#dot_" + indexOfSelectedDoc).style("fill", color_target)

                    var regexp = /\d+/g
                    if (Append_mode) {
                        let t = lasso.selectedItems()['_groups'][0].map(x => Number(x.getAttribute('id').match(regexp)[0]))
                        for (let i = 0; i < t.length; i++) {
                            if (!lassoSelectedDocs_id.includes(t[i])) {
                                lassoSelectedDocs_id.push(t[i])
                            }
                        }
                    } else {
                        lassoSelectedDocs_id = []
                        lassoSelectedDocs_id = lasso.selectedItems()['_groups'][0].map(x => Number(x.getAttribute('id').match(regexp)[0]))
                    }

                    renderSelectedNodes(scatter, lassoSelectedDocs_id, color_selected)
                };

                let lasso = d3.lasso()
                    .closePathSelect(true)
                    .closePathDistance(100)
                    .items(all_dots)
                    .targetArea(svg_scatterPlot)
                    .on("start", lasso_start)
                    .on("draw", lasso_draw)
                    .on("end", lasso_end);

                svg_scatterPlot.call(lasso);
            }

            function assignColor(index, isLabeled) {
                if (index == indexOfSelectedDoc) {
                    return color_target
                } else {
                    if(isLabeled == 1){
                        return 'grey'
                    }else{
                        return color_default
                    }
                }
            }
        }

        $(document).ready(function() {
            $("#next_doc_button").click(function() {
                label_input = $('input:radio:checked').val()
                var data = {
                    "label_input": label_input,
                    "query_instance_id": query_instance_id
                };
                jQuery.get("{% url 'engine:randomSampling' %}", data, function(ret) {
                    var next_instance = JSON.parse(ret['next_instance'])
                    query_instance_id = JSON.parse(ret['next_instance_id'])
                    d3.select('#text_being_labeled')
                        .text(next_instance['doc'])
                })
            })
            $("#label_doc_button").click(function() {
                label_input = $('input:radio:checked').val()
                var data = {
                    "label_input": label_input,
                    "query_instance_id": indexOfSelectedDoc
                };

                //有点问题
                data_dict[indexOfSelectedDoc].isLabeled = 1
                d3.select("#dot_" + indexOfSelectedDoc).style("fill", "grey")
                jQuery.get("{% url 'engine:labelSingleDoc' %}", data, function(ret) {

                })
            })
            $("#saveToFile").click(function() {
                var data = {};
                jQuery.get("{% url 'engine:saveLabledDataToFile' %}", data, function(ret) {

                })
            })

            document.addEventListener('keydown', keyEvent);

            function keyEvent(event) {
                if (event.key == 'Control') {
                    if (ZoomEnable) {
                        ZoomEnable = false
                        renderScatterPlot()
                    } else {
                        ZoomEnable = true
                        renderScatterPlot()
                    }
                }
                if (event.key == 'a') {
                    if (Append_mode) {
                        Append_mode = false
                    } else {
                        Append_mode = true
                    }
                }
            }
        })
    </script>
    <!-- <script src="{%static 'index.js' %}"></script> -->
  </body>
</html>